<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}情绪分享平台{% endblock %}</title>
    
    <!-- Favicon 和图标 -->
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon_16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon_32.png') }}">
    <link rel="icon" type="image/png" sizes="48x48" href="{{ url_for('static', filename='images/favicon_48.png') }}">
    <link rel="icon" type="image/png" sizes="64x64" href="{{ url_for('static', filename='images/favicon_64.png') }}">
    <link rel="icon" type="image/png" sizes="128x128" href="{{ url_for('static', filename='images/favicon_128.png') }}">
    <link rel="icon" type="image/png" sizes="256x256" href="{{ url_for('static', filename='images/favicon_256.png') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.png') }}">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="128x128" href="{{ url_for('static', filename='images/favicon_128.png') }}">
    <link rel="apple-touch-icon" sizes="256x256" href="{{ url_for('static', filename='images/favicon_256.png') }}">
    
    <!-- Android Chrome -->
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='images/favicon.png') }}">
    
    <!-- Leaflet 地图 CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- 自定义CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    {% block head %}{% endblock %}
</head>
<body style="background-color: white;">
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="{{ url_for('index') }}">🌤️ E-Weather</a>
            </div>
            
            <div class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-link">首页</a>
                
                {% if user %}
                    <a href="{{ url_for('profile') }}" class="user-info clickable">
                        <img src="{{ user.avatar_url }}" alt="头像" class="avatar-small">
                        <span>{{ user.username }}</span>
                    </a>
                    <form method="POST" action="{{ url_for('auth_logout') }}" style="display: inline;">
                        <button type="submit" class="nav-link logout-btn" style="background: none; border: none; color: inherit; cursor: pointer;">登出</button>
                    </form>
                {% else %}
                    <a href="{{ url_for('auth_login') }}" class="nav-link login-btn github-login-btn">
                        <svg class="github-logo" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                        </svg>
                        GitHub 登录
                    </a>
                {% endif %}
            </div>
        </div>
    </nav>
    
    <!-- 主要内容 -->
    <main class="main-content{% if request.endpoint == 'index' %} no-scroll{% endif %}">
        {% block content %}{% endblock %}
    </main>
    
    <!-- 固定的记录情绪按钮 -->
    {% if user %}
    <a href="{{ url_for('add_emotion') }}" class="floating-add-emotion-btn">➕ 记录情绪</a>
    {% else %}
    <button onclick="showLoginModal()" class="floating-add-emotion-btn">➕ 记录情绪</button>
    {% endif %}
    
    <!-- 登录提示弹窗 -->
    {% if not user %}
    <div id="loginModal" class="login-modal" style="display: none;">
        <div class="login-modal-content">
            <span class="login-modal-close" onclick="hideLoginModal()">&times;</span>
            <h3>请先登录后再试</h3>
            <p>您需要登录后才能记录情绪</p>
            <a href="{{ url_for('auth_login') }}" class="github-login-btn">
                <svg class="github-logo" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                GitHub 登录
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- Leaflet 地图 JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet 聚合插件 -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- 自定义JS -->
    {% block scripts %}{% endblock %}
    
    <!-- 登录弹窗控制脚本 -->
    {% if not user %}
    <script>
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }
        
        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }
        
        // 点击弹窗外部区域关闭弹窗
        window.onclick = function(event) {
            const modal = document.getElementById('loginModal');
            if (event.target === modal) {
                hideLoginModal();
            }
        }
        
        // ESC键关闭弹窗
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                hideLoginModal();
            }
        });
    </script>
    {% endif %}
</body>
</html>