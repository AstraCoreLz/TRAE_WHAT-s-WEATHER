{% extends "base.html" %}

{% block title %}E-Weather - æƒ…ç»ªå¤©æ°”{% endblock %}

{% block content %}

<!-- æƒ…ç»ªåˆ†äº«æ¨¡æ€æ¡† -->
{% if user %}
<div id="emotionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>åˆ†äº«ä½ çš„æƒ…ç»ª</h2>
            <span class="close">&times;</span>
        </div>
        
        <form id="emotionForm" class="emotion-form">
            <!-- æƒ…ç»ªé€‰æ‹© -->
            <div class="form-group">
                <label>é€‰æ‹©æƒ…ç»ª:</label>
                <div class="emotion-grid">
                    <div class="emotion-option" data-emotion="happy">
                        <span class="emotion-emoji">ğŸ˜Š</span>
                        <span class="emotion-label">å¼€å¿ƒ</span>
                    </div>
                    <div class="emotion-option" data-emotion="sad">
                        <span class="emotion-emoji">ğŸ˜¢</span>
                        <span class="emotion-label">éš¾è¿‡</span>
                    </div>
                    <div class="emotion-option" data-emotion="angry">
                        <span class="emotion-emoji">ğŸ˜ </span>
                        <span class="emotion-label">æ„¤æ€’</span>
                    </div>
                    <div class="emotion-option" data-emotion="excited">
                        <span class="emotion-emoji">ğŸ¤©</span>
                        <span class="emotion-label">å…´å¥‹</span>
                    </div>
                    <div class="emotion-option" data-emotion="calm">
                        <span class="emotion-emoji">ğŸ˜Œ</span>
                        <span class="emotion-label">å¹³é™</span>
                    </div>
                    <div class="emotion-option" data-emotion="anxious">
                        <span class="emotion-emoji">ğŸ˜°</span>
                        <span class="emotion-label">ç„¦è™‘</span>
                    </div>
                </div>
            </div>
            
            <!-- è‡ªå®šä¹‰emoji -->
            <div class="form-group">
                <label for="customEmoji">æˆ–è¾“å…¥è‡ªå®šä¹‰emoji:</label>
                <input type="text" id="customEmoji" name="customEmoji" placeholder="ğŸ‰" maxlength="2">
            </div>
            
            <!-- æƒ…ç»ªæè¿° -->
            <div class="form-group">
                <label for="emotionText">æè¿°ä½ çš„æ„Ÿå— (å¯é€‰):</label>
                <textarea id="emotionText" name="emotionText" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆè®©ä½ æœ‰è¿™ç§æ„Ÿå—..." maxlength="200"></textarea>
                <div class="char-count">0/200</div>
            </div>
            
            <!-- éšç§è®¾ç½® -->
            <div class="form-group privacy-settings">
                <h3>éšç§è®¾ç½®</h3>
                <div class="privacy-option">
                    <input type="checkbox" id="allowCollection" name="allowCollection" checked>
                    <label for="allowCollection">å…è®¸å…¶ä»–ç”¨æˆ·æ”¶è—</label>
                </div>
                <div class="privacy-option">
                    <input type="checkbox" id="isPublic" name="isPublic" checked>
                    <label for="isPublic">å…¬å¼€æ˜¾ç¤ºè¯¦ç»†å†…å®¹</label>
                    <small>å–æ¶ˆå‹¾é€‰åï¼Œå…¶ä»–ç”¨æˆ·åªèƒ½åœ¨åœ°å›¾ä¸Šçœ‹åˆ°emojiï¼Œæ— æ³•æŸ¥çœ‹è¯¦ç»†å†…å®¹</small>
                </div>
            </div>
            
            <!-- ä½ç½®ä¿¡æ¯ -->
            <div class="form-group">
                <button type="button" id="getLocationBtn" class="btn btn-secondary">è·å–æˆ‘çš„ä½ç½®</button>
                <div id="locationStatus" class="location-status"></div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">åˆ†äº«æƒ…ç»ª</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- åœ°å›¾å®¹å™¨ -->
<div class="map-section">
    <div id="map" class="emotion-map"></div>
    
    <!-- å·¦ä¸‹è§’æ§ä»¶ -->
    <div class="map-controls-left">
        <button id="emotionFilterBtn" class="circular-btn" title="æƒ…ç»ªç­›é€‰">
            <span class="btn-icon">ğŸ˜Š</span>
        </button>
        <button id="timeFilterBtn" class="circular-btn" title="æ—¶é—´èŒƒå›´">
            <span class="btn-icon">â°</span>
        </button>
        {% if session.user %}
        <a href="{{ url_for('add_emotion') }}" id="addEmotionBtn" class="circular-btn" title="æ·»åŠ æƒ…ç»ª">
            <span class="btn-icon">â•</span>
        </a>
        {% endif %}
    </div>
    
    <!-- å³ä¸‹è§’æ§ä»¶ -->
    <div class="map-controls-right">
        <button id="locateBtn" class="circular-btn" title="å®šä½åˆ°æˆ‘çš„ä½ç½®">
            <span class="btn-icon">ğŸ“</span>
        </button>
        <button id="refreshBtn" class="circular-btn" title="åˆ·æ–°åœ°å›¾">
            <span class="btn-icon">ğŸ”„</span>
        </button>
    </div>
    
    <!-- ç­›é€‰å¼¹å‡ºæ¡† -->
    <div id="emotionFilterPopup" class="filter-popup" style="display: none;">
        <h4>ç­›é€‰æƒ…ç»ª</h4>
        <select id="emotionFilter">
            <option value="all">å…¨éƒ¨</option>
            <option value="happy">ğŸ˜Š å¼€å¿ƒ</option>
            <option value="sad">ğŸ˜¢ éš¾è¿‡</option>
            <option value="angry">ğŸ˜  æ„¤æ€’</option>
            <option value="excited">ğŸ¤© å…´å¥‹</option>
            <option value="calm">ğŸ˜Œ å¹³é™</option>
            <option value="anxious">ğŸ˜° ç„¦è™‘</option>
        </select>
    </div>
    
    <!-- æ—¶é—´ç­›é€‰å¼¹å‡ºæ¡† -->
    <div id="timeFilterPopup" class="filter-popup" style="display: none;">
        <h4>æ—¶é—´èŒƒå›´</h4>
        <select id="timeFilter">
            <option value="24h">æœ€è¿‘24å°æ—¶</option>
            <option value="7d">æœ€è¿‘7å¤©</option>
            <option value="30d">æœ€è¿‘30å¤©</option>
            <option value="all">å…¨éƒ¨æ—¶é—´</option>
        </select>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// å…¨å±€ç”¨æˆ·çŠ¶æ€å˜é‡
window.isUserLoggedIn = {% if user %}true{% else %}false{% endif %};
window.currentUser = {% if user %}{{ user|tojson }}{% else %}null{% endif %};

// å…¨å±€å‡½æ•°ï¼šæ˜¾ç¤ºç™»å½•å¼¹çª—
function showLoginModal() {
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
        loginModal.style.display = 'block';
    }
}
</script>
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script src="{{ url_for('static', filename='js/emotion.js') }}"></script>

<!-- ç™»å‡ºæˆåŠŸæ¶ˆæ¯å¤„ç† -->
<script>
// æ£€æŸ¥URLå‚æ•°ä¸­çš„ç™»å‡ºæˆåŠŸæ¶ˆæ¯
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('logout') === 'success') {
        // æ˜¾ç¤ºç™»å‡ºæˆåŠŸæ¶ˆæ¯
        showLogoutSuccessMessage();
        
        // æ¸…é™¤URLå‚æ•°ï¼Œé¿å…åˆ·æ–°é¡µé¢æ—¶é‡å¤æ˜¾ç¤ºæ¶ˆæ¯
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
        window.history.replaceState({path: newUrl}, '', newUrl);
    }
    
    // æ£€æµ‹éœ€è¦ç™»å½•æç¤º
    if (urlParams.get('login_required') === 'true') {
        // æ˜¾ç¤ºéœ€è¦ç™»å½•æ¶ˆæ¯
        const message = document.createElement('div');
        message.innerHTML = 'è¯·å…ˆç™»å½•ä»¥è®¿é—®è¯¥åŠŸèƒ½';
        message.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f59e0b;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-size: 14px;
            font-weight: 500;
        `;
        document.body.appendChild(message);
        
        // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            message.remove();
        }, 5000);
        
        // æ¸…é™¤URLå‚æ•°
        urlParams.delete('login_required');
        const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
        window.history.replaceState({}, '', newUrl);
    }
});

// æ˜¾ç¤ºç™»å‡ºæˆåŠŸæ¶ˆæ¯
function showLogoutSuccessMessage() {
    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
    const messageEl = document.createElement('div');
    messageEl.className = 'logout-success-message';
    messageEl.innerHTML = `
        <div class="message-content">
            <span class="success-icon">âœ…</span>
            <span class="message-text">å·²æˆåŠŸç™»å‡º</span>
        </div>
    `;
    
    // æ·»åŠ æ ·å¼
    messageEl.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 14px;
        font-weight: 500;
        animation: slideInRight 0.3s ease-out;
        max-width: 300px;
    `;
    
    // æ·»åŠ åŠ¨ç”»æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .logout-success-message .message-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logout-success-message .success-icon {
            font-size: 16px;
        }
    `;
    document.head.appendChild(style);
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(messageEl);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        messageEl.style.animation = 'slideInRight 0.3s ease-out reverse';
        setTimeout(() => {
            if (messageEl.parentNode) {
                messageEl.parentNode.removeChild(messageEl);
            }
        }, 300);
    }, 3000);
}
</script>
{% endblock %}